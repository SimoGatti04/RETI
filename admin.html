<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Commenti - Admin</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f6f8fa;
            color: #333;
        }
        h1 {
            border-bottom: 2px solid #0366d6;
            padding-bottom: 10px;
            margin-bottom: 30px;
        }
        .auth-screen {
            max-width: 500px;
            margin: 100px auto;
            background: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
        }
        .auth-screen input {
            width: 100%;
            padding: 12px;
            margin: 15px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1em;
        }
        .auth-screen button {
            width: 100%;
            padding: 12px;
            background: #0366d6;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }
        .auth-screen button:hover {
            background: #0256c2;
        }
        .error-message {
            color: #dc3545;
            margin-top: 10px;
            font-size: 0.9em;
        }
        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            flex: 1;
            min-width: 150px;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #0366d6;
        }
        .filters {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        .filters select, .filters input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1em;
        }
        .comment {
            background: white;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 8px;
            border-left: 4px solid #0366d6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .comment.pending {
            border-left-color: #ffc107;
            background: #fffbf0;
        }
        .comment.approved {
            border-left-color: #28a745;
        }
        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .comment-meta {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 600;
        }
        .badge.pending {
            background: #ffc107;
            color: #000;
        }
        .badge.approved {
            background: #28a745;
            color: white;
        }
        .comment-text {
            margin: 15px 0;
            white-space: pre-wrap;
            line-height: 1.6;
            padding: 15px;
            background: #f6f8fa;
            border-radius: 4px;
        }
        .reply-section {
            margin-top: 15px;
            padding: 15px;
            background: #e8f5e9;
            border-radius: 4px;
            border-left: 3px solid #28a745;
        }
        .actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95em;
            transition: opacity 0.2s;
        }
        button:hover {
            opacity: 0.9;
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .btn-approve {
            background: #28a745;
            color: white;
        }
        .btn-delete {
            background: #dc3545;
            color: white;
        }
        .btn-reply {
            background: #0366d6;
            color: white;
        }
        .reply-form {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .reply-form textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
            font-size: 1em;
            resize: vertical;
            min-height: 100px;
        }
        .reply-form button {
            margin-top: 10px;
        }
        #loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        #no-comments {
            text-align: center;
            padding: 40px;
            color: #666;
            background: white;
            border-radius: 8px;
        }
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        .admin-header a {
            color: #0366d6;
            text-decoration: none;
            padding: 8px 16px;
            border: 1px solid #0366d6;
            border-radius: 4px;
        }
        .admin-header a:hover {
            background: #0366d6;
            color: white;
        }
    </style>
</head>
<body>
    <!-- Schermata di autenticazione -->
    <div id="auth-screen" class="auth-screen">
        <h2>üîí Accesso Admin</h2>
        <p>Inserisci il token di accesso per gestire i commenti</p>
        <input type="password" id="admin-token" placeholder="Token di accesso" autocomplete="off">
        <button onclick="checkAuth()">Accedi</button>
        <div id="auth-error" class="error-message"></div>
    </div>

    <!-- Pannello admin (nascosto fino all'autenticazione) -->
    <div id="admin-panel" style="display: none;">
        <div class="admin-header">
            <h1>üîß Gestione Commenti</h1>
            <a href="index.html">‚Üê Torna al sito</a>
        </div>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="total-comments">0</div>
                <div>Commenti totali</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="pending-comments">0</div>
                <div>In attesa</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="approved-comments">0</div>
                <div>Approvati</div>
            </div>
        </div>

        <div class="filters">
            <label><strong>Filtra per pagina:</strong></label>
            <select id="page-filter">
                <option value="all">Tutte le pagine</option>
                <option value="index">Index</option>
                <option value="Cap01">Capitolo 1</option>
                <option value="Cap02">Capitolo 2</option>
                <option value="Cap03">Capitolo 3</option>
            </select>
            <label><strong>Stato:</strong></label>
            <select id="status-filter">
                <option value="all">Tutti</option>
                <option value="pending">In attesa</option>
                <option value="approved">Approvati</option>
            </select>
            <button onclick="loadComments()" style="background: #0366d6; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer;">Aggiorna</button>
        </div>

        <div id="comments-container">
            <div id="loading">Caricamento commenti...</div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <script>
        // Attendi che Firebase sia completamente caricato
        (function() {
            function waitForFirebase() {
                if (typeof firebase !== 'undefined' && typeof firebase.initializeApp === 'function') {
                    console.log('Firebase SDK caricato correttamente');
                    // Firebase √® pronto, lo script principale pu√≤ procedere
                } else {
                    console.log('Attendo caricamento Firebase...');
                    setTimeout(waitForFirebase, 50);
                }
            }
            waitForFirebase();
        })();
    </script>

    <script>
        // ============================================
        // CONFIGURAZIONE
        // ============================================
        // IMPORTANTE: Configura questi valori
        const ADMIN_TOKEN = '130904'; // Cambia con un token segreto a tua scelta
        const firebaseConfig = {
            apiKey: "AIzaSyAMpUAxKATJEbkE_kiae1TSlMlTaFu2gj0",
            authDomain: "class-bda53.firebaseapp.com",
            databaseURL: "https://class-bda53-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "class-bda53",
            storageBucket: "class-bda53.firebasestorage.app",
            messagingSenderId: "167876134694",
            appId: "1:167876134694:web:14bfc2a065b0be40c963e7"
        };

        // ============================================
        // AUTENTICAZIONE
        // ============================================
        function checkAuth() {
            const tokenInput = document.getElementById('admin-token');
            const errorDiv = document.getElementById('auth-error');
            const token = tokenInput.value.trim();

            if (token === ADMIN_TOKEN) {
                // Salva il token in sessionStorage per questa sessione
                sessionStorage.setItem('admin_authenticated', 'true');
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('admin-panel').style.display = 'block';
                initAdmin();
            } else {
                errorDiv.textContent = 'Token non valido. Riprova.';
                tokenInput.value = '';
                tokenInput.focus();
            }
        }

        // Verifica se gi√† autenticato
        if (sessionStorage.getItem('admin_authenticated') === 'true') {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('admin-panel').style.display = 'block';
            initAdmin();
        } else {
            // Focus sul campo token
            document.getElementById('admin-token').focus();
            // Permetti invio con Enter
            document.getElementById('admin-token').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    checkAuth();
                }
            });
        }

        // ============================================
        // FIREBASE E GESTIONE COMMENTI
        // ============================================
        let allComments = [];
        // Usa window.database invece di una variabile let per evitare problemi di scope

        function initAdmin() {
            // Verifica che Firebase sia caricato
            if (typeof firebase === 'undefined') {
                console.error('Firebase non caricato. Attendo...');
                setTimeout(initAdmin, 100);
                return;
            }

            // Inizializza database come variabile locale prima
            let dbInstance = null;

            try {
                // Controlla se Firebase √® gi√† inizializzato
                // Nella versione compat, firebase.apps potrebbe non essere disponibile
                let app;
                let isInitialized = false;
                
                try {
                    // Prova a ottenere l'app di default
                    app = firebase.app();
                    isInitialized = true;
                    console.log('Firebase gi√† inizializzato, uso app esistente');
                } catch (e) {
                    // Firebase non inizializzato, inizializzalo
                    console.log('Firebase non inizializzato, procedo con inizializzazione');
                    isInitialized = false;
                }

                if (!isInitialized) {
                    try {
                        app = firebase.initializeApp(firebaseConfig);
                        console.log('Firebase inizializzato con successo');
                    } catch (initError) {
                        // Se fallisce per duplicate-app, usa l'app esistente
                        if (initError.code === 'app/duplicate-app' || (initError.message && initError.message.includes('duplicate'))) {
                            console.log('Firebase gi√† inizializzato (duplicate-app), uso app esistente');
                            app = firebase.app();
                        } else {
                            throw initError;
                        }
                    }
                }
                
                // Ottieni il database
                dbInstance = firebase.database();
                console.log('Database ottenuto:', dbInstance);
                
            } catch (error) {
                console.error('Errore inizializzazione Firebase:', error);
                console.error('Dettagli errore:', {
                    code: error.code,
                    message: error.message,
                    name: error.name,
                    stack: error.stack
                });
                
                // Prova comunque ad accedere al database
                try {
                    console.log('Tento comunque di accedere al database...');
                    dbInstance = firebase.database();
                    console.log('Accesso al database riuscito nonostante errore inizializzazione');
                } catch (dbError) {
                    console.error('Errore accesso database:', dbError);
                    const container = document.getElementById('comments-container');
                    if (container) {
                        container.innerHTML = '<div id="no-comments">Errore nell\'accesso al database: ' + (dbError.message || dbError) + '<br>Controlla la console per maggiori dettagli.</div>';
                    }
                    return; // Esci se non riesci ad accedere al database
                }
            }

            // Assegna il database a window.database solo se tutto √® andato bene
            if (dbInstance) {
                window.database = dbInstance; // Usa direttamente window.database
                console.log('Database assegnato a window.database');
                loadComments();
            } else {
                console.error('Database non disponibile');
                const container = document.getElementById('comments-container');
                if (container) {
                    container.innerHTML = '<div id="no-comments">Impossibile accedere al database. Ricarica la pagina.</div>';
                }
            }
        }

        function loadComments() {
            if (!window.database) {
                console.log('Database non ancora disponibile, riprovo tra 100ms...');
                setTimeout(loadComments, 100);
                return;
            }

            const container = document.getElementById('comments-container');
            if (!container) {
                console.error('Container commenti non trovato');
                return;
            }
            
            container.innerHTML = '<div id="loading">Caricamento commenti...</div>';

            console.log('Caricamento commenti da Firebase...');
            const commentsRef = window.database.ref('comments');
            
            // Usa on() invece di once() per aggiornamenti in tempo reale
            // Rimuovi il listener precedente se esiste
            if (window.commentsListener) {
                commentsRef.off('value', window.commentsListener);
            }
            
            window.commentsListener = (snapshot) => {
                console.log('Snapshot ricevuto:', snapshot.exists() ? 'dati presenti' : 'nessun dato');
                allComments = [];
                if (snapshot.exists()) {
                    snapshot.forEach((pageSnapshot) => {
                        const pageKey = pageSnapshot.key;
                        console.log('Pagina trovata:', pageKey);
                        pageSnapshot.forEach((commentSnapshot) => {
                            const comment = commentSnapshot.val();
                            allComments.push({
                                id: commentSnapshot.key,
                                page: pageKey,
                                ...comment
                            });
                        });
                    });
                    console.log('Commenti caricati:', allComments.length);
                } else {
                    console.log('Nessun commento trovato nel database');
                }

                updateStats();
                displayComments();
            };
            
            commentsRef.on('value', window.commentsListener, (error) => {
                if (error) {
                    console.error('Errore nel listener:', error);
                    console.error('Dettagli errore:', {
                        code: error.code,
                        message: error.message,
                        stack: error.stack
                    });
                    const container = document.getElementById('comments-container');
                    if (container) {
                        container.innerHTML = '<div id="no-comments">Errore nel caricamento dei commenti: ' + (error.message || error) + '<br>Controlla la console per maggiori dettagli.</div>';
                    }
                }
            });
        }

        function updateStats() {
            const total = allComments.length;
            const pending = allComments.filter(c => !c.approved).length;
            const approved = allComments.filter(c => c.approved).length;

            document.getElementById('total-comments').textContent = total;
            document.getElementById('pending-comments').textContent = pending;
            document.getElementById('approved-comments').textContent = approved;
        }

        function displayComments() {
            const pageFilter = document.getElementById('page-filter').value;
            const statusFilter = document.getElementById('status-filter').value;
            const container = document.getElementById('comments-container');

            let filtered = allComments;

            if (pageFilter !== 'all') {
                filtered = filtered.filter(c => {
                    const pageKey = c.page.replace(/[^a-zA-Z0-9]/g, '_');
                    return pageKey === pageFilter || c.page === pageFilter;
                });
            }

            if (statusFilter === 'pending') {
                filtered = filtered.filter(c => !c.approved);
            } else if (statusFilter === 'approved') {
                filtered = filtered.filter(c => c.approved);
            }

            // Ordina per data (pi√π recenti prima)
            filtered.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

            if (filtered.length === 0) {
                container.innerHTML = '<div id="no-comments">Nessun commento trovato.</div>';
                return;
            }

            container.innerHTML = filtered.map(comment => {
                // comment.page √® gi√† il pageKey corretto dal database (pageSnapshot.key)
                // Non sanitizzarlo di nuovo, usalo direttamente per le operazioni sul database
                const dbPageKey = String(comment.page); // Questo √® gi√† il pageKey corretto dal path del database
                
                // Per il nome della pagina da mostrare, crea una versione leggibile
                let displayPageKey = dbPageKey;
                // Rimuovi underscore finali o conversioni strane per mostrare un nome pi√π leggibile
                if (displayPageKey === 'index_html') displayPageKey = 'index';
                const pageName = {
                    'index': 'Index',
                    'Cap01': 'Capitolo 1',
                    'Cap02': 'Capitolo 2',
                    'Cap03': 'Capitolo 3'
                }[displayPageKey] || displayPageKey;

                // Sanitizza ID per uso in HTML (rimuove caratteri problematici)
                const safeId = String(comment.id).replace(/[^a-zA-Z0-9_-]/g, '_');
                const safePageKey = String(dbPageKey).replace(/[^a-zA-Z0-9_-]/g, '_');

                return `
                    <div class="comment ${comment.approved ? 'approved' : 'pending'}" id="comment-${safeId}">
                        <div class="comment-header">
                            <div>
                                <strong style="font-size: 1.1em; color: #0366d6;">${escapeHtml(comment.name)}</strong>
                                <div class="comment-meta" style="margin-top: 5px;">
                                    <span class="badge ${comment.approved ? 'approved' : 'pending'}">
                                        ${comment.approved ? '‚úì Approvato' : '‚è≥ In attesa'}
                                    </span>
                                    <span style="color: #666;">üìÑ ${pageName}</span>
                                    <span style="color: #666;">üïí ${formatDate(comment.timestamp)}</span>
                                </div>
                            </div>
                        </div>
                        <div class="comment-text">${escapeHtml(comment.text)}</div>
                        ${comment.reply ? `
                            <div class="reply-section">
                                <strong style="color: #28a745; display: block; margin-bottom: 8px;">Risposta:</strong>
                                <p style="margin: 0; white-space: pre-wrap;">${escapeHtml(comment.reply)}</p>
                                ${comment.replyTimestamp ? `<small style="color: #666; display: block; margin-top: 8px;">${formatDate(comment.replyTimestamp)}</small>` : ''}
                            </div>
                        ` : ''}
                        <div class="actions">
                            ${!comment.approved ? `<button class="btn-approve" data-comment-id="${comment.id}" data-page-key="${dbPageKey}" onclick="approveCommentHandler(this)">‚úì Approva</button>` : ''}
                            <button class="btn-reply" data-comment-id="${comment.id}" data-safe-id="${safeId}" onclick="toggleReplyFormHandler('${safeId}')">üí¨ Rispondi</button>
                            <button class="btn-delete" data-comment-id="${comment.id}" data-page-key="${dbPageKey}" onclick="deleteCommentHandler(this)">üóëÔ∏è Elimina</button>
                        </div>
                        <div id="reply-form-${safeId}" class="reply-form" style="display: none;">
                            <textarea id="reply-text-${safeId}" placeholder="Scrivi la tua risposta..."></textarea>
                            <button class="btn-reply" data-comment-id="${comment.id}" data-page-key="${dbPageKey}" data-safe-id="${safeId}" onclick="sendReplyHandler(this)">Invia risposta</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Funzioni handler per evitare problemi con escape e accesso globale
        function approveCommentHandler(button) {
            const id = button.getAttribute('data-comment-id');
            const pageKey = button.getAttribute('data-page-key');
            approveComment(id, pageKey);
        }

        function deleteCommentHandler(button) {
            const id = button.getAttribute('data-comment-id');
            const pageKey = button.getAttribute('data-page-key');
            deleteComment(id, pageKey);
        }

        function toggleReplyFormHandler(id) {
            toggleReplyForm(id);
        }

        function sendReplyHandler(button) {
            const id = button.getAttribute('data-comment-id');
            const pageKey = button.getAttribute('data-page-key');
            const safeId = button.getAttribute('data-safe-id') || id;
            sendReply(id, pageKey, safeId);
        }

        function approveComment(id, pageKey) {
            if (!window.database) {
                alert('Database non inizializzato. Ricarica la pagina.');
                return;
            }

            // pageKey √® gi√† il pageKey corretto dal database, usalo direttamente
            // Ma assicuriamoci che non contenga caratteri non validi (dovrebbe gi√† essere sicuro)
            const sanitizedPageKey = String(pageKey).replace(/[.#$\[\]]/g, '_');
            
            console.log('Approvazione commento:', { id, pageKey, sanitizedPageKey });
            const commentRef = window.database.ref(`comments/${sanitizedPageKey}/${id}`);
            commentRef.update({ approved: true })
                .then(() => {
                    console.log('Commento approvato con successo');
                    loadComments();
                })
                .catch(err => {
                    console.error('Errore approvazione:', err);
                    alert('Errore nell\'approvazione: ' + (err.message || err));
                });
        }

        function deleteComment(id, pageKey) {
            if (!window.database) {
                alert('Database non inizializzato. Ricarica la pagina.');
                return;
            }

            if (!confirm('Sei sicuro di voler eliminare questo commento?')) return;
            
            // pageKey √® gi√† il pageKey corretto dal database, usalo direttamente
            // Ma assicuriamoci che non contenga caratteri non validi (dovrebbe gi√† essere sicuro)
            const sanitizedPageKey = String(pageKey).replace(/[.#$\[\]]/g, '_');
            
            console.log('Eliminazione commento:', { id, pageKey, sanitizedPageKey });
            const commentRef = window.database.ref(`comments/${sanitizedPageKey}/${id}`);
            commentRef.remove()
                .then(() => {
                    console.log('Commento eliminato con successo');
                    loadComments();
                })
                .catch(err => {
                    console.error('Errore eliminazione:', err);
                    alert('Errore nell\'eliminazione: ' + (err.message || err));
                });
        }

        function toggleReplyForm(id) {
            const form = document.getElementById(`reply-form-${id}`);
            if (form) {
                form.style.display = form.style.display === 'none' ? 'block' : 'none';
            }
        }

        function sendReply(id, pageKey, safeId) {
            if (!window.database) {
                alert('Database non inizializzato. Ricarica la pagina.');
                return;
            }

            // Usa safeId per trovare il textarea (per l'ID HTML)
            const replyTextarea = document.getElementById(`reply-text-${safeId || id}`);
            if (!replyTextarea) {
                alert('Errore: campo risposta non trovato.');
                return;
            }

            const replyText = replyTextarea.value.trim();
            if (!replyText) {
                alert('Inserisci una risposta!');
                return;
            }

            // pageKey √® gi√† il pageKey corretto dal database, usalo direttamente
            // Ma assicuriamoci che non contenga caratteri non validi (dovrebbe gi√† essere sicuro)
            const sanitizedPageKey = String(pageKey).replace(/[.#$\[\]]/g, '_');
            
            console.log('Invio risposta:', { id, pageKey, sanitizedPageKey, replyText });
            const commentRef = window.database.ref(`comments/${sanitizedPageKey}/${id}`);
            commentRef.update({
                reply: replyText,
                replyTimestamp: Date.now()
            })
            .then(() => {
                console.log('Risposta inviata con successo');
                replyTextarea.value = '';
                toggleReplyForm(safeId || id);
                loadComments();
            })
            .catch(err => {
                console.error('Errore invio risposta:', err);
                alert('Errore nell\'invio della risposta: ' + (err.message || err));
            });
        }

        // Rendi le funzioni accessibili globalmente
        window.approveComment = approveComment;
        window.deleteComment = deleteComment;
        window.toggleReplyForm = toggleReplyForm;
        window.sendReply = sendReply;
        window.approveCommentHandler = approveCommentHandler;
        window.deleteCommentHandler = deleteCommentHandler;
        window.toggleReplyFormHandler = toggleReplyFormHandler;
        window.sendReplyHandler = sendReplyHandler;

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            return date.toLocaleDateString('it-IT', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Filtri
        document.getElementById('page-filter').addEventListener('change', displayComments);
        document.getElementById('status-filter').addEventListener('change', displayComments);

        // Non serve pi√π l'auto-refresh perch√© usiamo listener in tempo reale
        // Il listener si aggiorna automaticamente quando ci sono cambiamenti nel database
    </script>
</body>
</html>

